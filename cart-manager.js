class CartManager{constructor(){this.cartKey='peintureLandCart';this.cart=this.loadCart();this.initEventListeners()}initEventListeners(){document.addEventListener('click',e=>{if(e.target.classList.contains('add-to-cart')||e.target.closest('.add-to-cart')){e.preventDefault();this.handleAddToCart(e)}})}handleAddToCart(e){const b=e.target.classList.contains('add-to-cart')?e.target:e.target.closest('.add-to-cart');const p={id:b.dataset.productId,name:b.dataset.productName,description:b.dataset.productDescription,image_url:b.dataset.productImage,brand_id:b.dataset.brandId};this.addItem(p)}loadCart(){try{const c=localStorage.getItem(this.cartKey);if(!c)return[];let cart=JSON.parse(c);if(cart.length>0&&!cart[0].key){cart=cart.map(i=>{let s=null;if(i.shade){const p=i.shade.split(' - ');s={id:'migrated_'+Date.now()+Math.random(),code:p[0]||'',name:p[1]||'',hex:null}}return{key:s?`${i.id}_${s.id}`:`${i.id}_no-shade`,id:i.id,name:i.name,description:i.description,image_url:i.image_url,brand_id:i.brand_id,shade:s,quantity:i.quantity||1}});localStorage.setItem(this.cartKey,JSON.stringify(cart));console.log('Cart migrated to new format:',cart.length,'items')}return cart}catch(e){console.error('Error loading cart:',e);return[]}}saveCart(){try{localStorage.setItem(this.cartKey,JSON.stringify(this.cart));this.updateCartCount()}catch(e){console.error('Error saving cart:',e)}}updateCartCount(){const t=this.getTotalItems();document.querySelectorAll('.cart-count').forEach(e=>{e.textContent=t;e.classList.add('animate-pulse');setTimeout(()=>e.classList.remove('animate-pulse'),300)})}addItem(p,q=1){const m=(p&&typeof p.stock==='number'&&p.stock>0)?p.stock:9999,s=Math.max(1,Math.min(parseInt(q,10)||1,m)),sid=p.shade?p.shade.id:'no-shade',k=`${p.id}_${sid}`,ex=this.cart.find(i=>i.key===k);if(ex){const n=Math.max(1,Math.min(ex.quantity+s,m));ex.quantity=n}else{this.cart.push({key:k,id:p.id,name:p.name,description:p.description,image_url:p.image_url,brand_id:p.brand_id,shade:p.shade,quantity:s,price:p.price,stock:p.stock})}this.saveCart();this.showNotification(`${p.name} added to cart`)}removeItem(k){this.cart=this.cart.filter(i=>i.key!==k);this.saveCart()}updateQuantity(k,q){const i=this.cart.find(i=>i.key===k);if(i){const m=(typeof i.stock==='number'&&i.stock>0)?i.stock:9999,s=Math.max(1,Math.min(parseInt(q,10)||1,m));if(s<=0)this.removeItem(k);else{i.quantity=s;this.saveCart()}}}clearCart(){this.cart=[];this.saveCart()}getCartItems(){return[...this.cart]}getTotalItems(){return this.cart.reduce((t,i)=>t+i.quantity,0)}showNotification(m){const n=document.createElement('div');n.className='cart-notification';n.innerHTML=`<div class="notification-content"><i class="fas fa-check-circle"></i><span>${m}</span></div>`;n.style.cssText='position:fixed;top:20px;right:20px;background:linear-gradient(135deg,#4facfe 0%,#00f2fe 100%);color:white;padding:15px 25px;border-radius:10px;box-shadow:0 5px 15px rgba(0,0,0,0.2);z-index:10000;font-weight:600;';document.body.appendChild(n);if(typeof gsap!=='undefined'){gsap.fromTo(n,{x:100,opacity:0},{x:0,opacity:1,duration:.3,ease:"back.out(1.7)",onComplete:()=>{setTimeout(()=>{gsap.to(n,{x:100,opacity:0,duration:.3,ease:"power2.in",onComplete:()=>{n.parentNode&&n.remove()}})},2500)}})}}}window.updateCartCountGlobal=function(){if(window.cartManager)window.cartManager.updateCartCount();else{const c=JSON.parse(localStorage.getItem('peintureLandCart'))||[],t=c.reduce((t,i)=>t+i.quantity,0);document.querySelectorAll('.cart-count').forEach(e=>e.textContent=t)}};window.initializeCartManager=function(){if(!window.cartManager){window.cartManager=new CartManager();console.log('Cart manager initialized')}};document.readyState==='loading'?document.addEventListener('DOMContentLoaded',()=>window.initializeCartManager()):window.initializeCartManager();