class SearchSystem{constructor(){this.searchInput=null;this.searchForm=null;this.searchDropdown=null;this.isDropdownOpen=!1;this.currentSearchQuery='';this.debounceTimer=null;this.minQueryLength=3;this.maxDropdownResults=5;this.isLoading=!1;this.init()}init(){document.readyState==='loading'?document.addEventListener('DOMContentLoaded',()=>this.setupSearch()):this.setupSearch()}setupSearch(){this.searchInput=document.getElementById('globalSearchInput');this.searchForm=document.getElementById('globalSearchForm');this.searchDropdown=document.getElementById('searchDropdown');if(!this.searchInput||!this.searchForm||!this.searchDropdown){console.warn('Search elements not found - search functionality disabled');return}this.searchInput.addEventListener('input',e=>this.handleInput(e));this.searchInput.addEventListener('focus',()=>this.showDropdown());this.searchForm.addEventListener('submit',e=>this.handleSubmit(e));document.addEventListener('click',e=>this.handleClickOutside(e));document.addEventListener('keydown',e=>{if(e.key==='Escape'&&this.isDropdownOpen)this.hideDropdown()});console.log('Search system initialized')}handleInput(e){const q=e.target.value.trim();this.currentSearchQuery=q;if(q.length<this.minQueryLength){this.hideDropdown();return}clearTimeout(this.debounceTimer);this.debounceTimer=setTimeout(()=>{this.performLiveSearch(q)},300)}handleSubmit(e){e.preventDefault();const q=this.searchInput.value.trim();if(!q)return;this.hideDropdown();window.location.href=`search.html?q=${encodeURIComponent(q)}`}handleClickOutside(e){if(!this.searchDropdown.contains(e.target)&&!this.searchForm.contains(e.target))this.hideDropdown()}showDropdown(){if(this.currentSearchQuery.length>=this.minQueryLength){this.searchDropdown.classList.add('active');this.isDropdownOpen=!0}}hideDropdown(){this.searchDropdown.classList.remove('active');this.isDropdownOpen=!1}async performLiveSearch(q){if(this.isLoading)return;this.isLoading=!0;this.showLoadingState();try{if(!window.supabaseClient)await window.ensureSupabase();if(!window.supabaseClient)throw new Error('Supabase client not available');const[b,p]=await Promise.all([this.searchBrands(q),this.searchProducts(q,this.maxDropdownResults,0)]);const brands=b?.data||[],products=p?.data||[];const r=this.combineAndRankResults(products,brands);this.updateDropdown(r,q)}catch(e){console.error('Search error:',e);this.showErrorState()}finally{this.isLoading=!1}}async searchBrands(q){try{return await window.supabaseClient.rpc('search_brands',{search_query:q,limit_count:3})}catch(e){console.error('Brand search error:',e);return{data:[],error:e}}}async searchProducts(q,l=10,o=0){try{return await window.supabaseClient.rpc('search_products',{search_query:q,limit_count:l,offset_count:o})}catch(e){console.error('Product search error:',e);return{data:[],error:e}}}combineAndRankResults(p,b){const rankedProducts=p.sort((a,b)=>(b.rank||0)-(a.rank||0)).slice(0,this.maxDropdownResults);const rankedBrands=b.slice(0,2);return{products:rankedProducts,brands:rankedBrands}}updateDropdown(r,q){const{products:p,brands:b}=r;const hp=p.length>0,hb=b.length>0;if(!hp&&!hb){this.showNoResults(q);return}let html='';if(hb){html+=`<div class="dropdown-section"><h4>Brands</h4><div class="dropdown-results">${b.map(b=>this.createBrandDropdownItem(b,q)).join('')}</div></div>`}if(hp){html+=`<div class="dropdown-section"><h4>Products</h4><div class="dropdown-results">${p.map(p=>this.createProductDropdownItem(p,q)).join('')}</div></div>`}html+=`<a href="search.html?q=${encodeURIComponent(q)}" class="view-all-results">View all results for "${this.highlightText(q,q)}"<i class="fas fa-arrow-right ml-2"></i></a>`;this.searchDropdown.innerHTML=html;this.showDropdown()}createBrandDropdownItem(b,q){const n=this.highlightText(b.name||'',q);return`<a href="brand.html?id=${b.id}" class="dropdown-item"><img src="${b.logo_url||'https://images.unsplash.com/photo-1581094794329-c8112a89af12?w=100&h=100&fit=crop'}" alt="${b.name}" onerror="this.src='https://images.unsplash.com/photo-1581094794329-c8112a89af12?w=100&h=100&fit=crop'"><div class="dropdown-item-content"><div class="dropdown-item-name">${n}</div></div><i class="fas fa-arrow-right text-muted"></i></a>`}createProductDropdownItem(p,q){const n=this.highlightText(p.name||'',q),b=this.highlightText(p.brand_name||'',q);return`<a href="product.html?id=${p.id}" class="dropdown-item"><img src="${p.image_url||'https://images.unsplash.com/photo-1581094794329-c8112a89af12?w=100&h=100&fit=crop'}" alt="${p.name}" onerror="this.src='https://images.unsplash.com/photo-1581094794329-c8112a89af12?w=100&h=100&fit=crop'"><div class="dropdown-item-content"><div class="dropdown-item-name">${n}</div><div class="dropdown-item-brand">${b}</div></div><i class="fas fa-arrow-right text-muted"></i></a>`}highlightText(t,q){if(!q||!t)return t;const lt=t.toLowerCase(),lq=q.toLowerCase();if(!lt.includes(lq))return t;const i=lt.indexOf(lq),e=i+q.length;return t.substring(0,i)+'<mark>'+t.substring(i,e)+'</mark>'+t.substring(e)}showLoadingState(){this.searchDropdown.innerHTML=`<div class="loading-results"><i class="fas fa-spinner fa-spin"></i><div>Searching...</div></div>`;this.showDropdown()}showNoResults(q){this.searchDropdown.innerHTML=`<div class="no-results"><i class="fas fa-search"></i><div>No results found for "${q}"</div></div>`;this.showDropdown()}showErrorState(){this.searchDropdown.innerHTML=`<div class="no-results"><i class="fas fa-exclamation-triangle"></i><div>Search temporarily unavailable</div></div>`;this.showDropdown()}}class SearchResultsPage{constructor(){this.resultsGrid=null;this.loader=null;this.currentPage=0;this.hasMoreResults=!0;this.isLoading=!1;this.currentQuery='';this.limit=12;window.location.pathname.includes('search.html')&&this.initResultsPage()}async initResultsPage(){const p=new URLSearchParams(window.location.search);this.currentQuery=p.get('q')||'';if(!this.currentQuery){window.location.href='index.html';return}document.title=`Search: ${this.currentQuery} - PEINTURE LAND`;const qd=document.getElementById('searchQuery');qd&&(qd.textContent=this.currentQuery);this.resultsGrid=document.getElementById('searchResultsGrid');this.loader=document.getElementById('infiniteScrollLoader');if(!this.resultsGrid){console.error('Search results grid not found');return}await this.loadResults();this.setupInfiniteScroll();window.gsapAnimations&&typeof window.gsapAnimations.refreshAnimations==='function'&&setTimeout(()=>window.gsapAnimations.refreshAnimations(),100)}async loadResults(){if(this.isLoading||!this.hasMoreResults)return;this.isLoading=!0;this.showLoading(!0);try{if(!window.supabaseClient)await window.ensureSupabase();const r=await this.searchProducts(this.currentQuery,this.limit,this.currentPage*this.limit);const p=r?.data||[];this.hasMoreResults=p.length===this.limit;p.length>0?(this.renderProducts(p),this.updateResultsCount()):this.currentPage===0&&this.showNoResults();this.currentPage++}catch(e){console.error('Error loading search results:',e);this.showError()}finally{this.isLoading=!1;this.showLoading(!1)}}async searchProducts(q,l,o){try{return await window.supabaseClient.rpc('search_products',{search_query:q,limit_count:l,offset_count:o})}catch(e){console.error('Search RPC error:',e);throw e}}renderProducts(p){p.forEach(p=>{const c=this.createSearchProductCard(p);c&&this.resultsGrid.appendChild(c)});setTimeout(()=>{typeof ScrollTrigger!=='undefined'&&ScrollTrigger.refresh();window.gsapAnimations&&typeof window.gsapAnimations.refreshAnimations==='function'&&window.gsapAnimations.refreshAnimations()},100)}createSearchProductCard(p){if(window.websiteFunctions&&typeof window.websiteFunctions.createProductCard==='function'){const c=window.websiteFunctions.createProductCard({...p,product_properties:[]},p.brand_name||'');this.highlightCardText(c,p);return c}const c=document.createElement('a');c.href=`product.html?id=${p.id}`;c.className='product-card will-animate';const d=p.description&&p.description.length>100?p.description.substring(0,100)+'...':p.description||'',hn=this.highlightText(p.name,this.currentQuery),hd=this.highlightText(d,this.currentQuery),hb=this.highlightText(p.brand_name||'',this.currentQuery);c.innerHTML=`<div class="product-image-container"><img src="${p.image_url||'https://images.unsplash.com/photo-1581094794329-c8112a89af12?w=400&h=300&fit=crop'}" alt="${p.name}" class="product-image"></div><div class="product-info"><div class="brand-badge">ðŸ”– ${hb}</div><h3 class="product-name">${hn}</h3><div class="product-description-container"><p class="product-description">${hd}</p></div><div class="product-actions"><button class="btn add-to-cart" data-product-id="${p.id}" data-product-name="${p.name}" data-product-description="${p.description}" data-product-image="${p.image_url||''}" data-brand-id="${p.brand_id}"><i class="fas fa-cart-plus"></i> Add To Cart</button><span class="view-details">View Details <i class="fas fa-arrow-right"></i></span></div></div>`;setTimeout(()=>{c.querySelector('.add-to-cart')?.addEventListener('click',e=>{e.preventDefault();e.stopPropagation();const pd={id:p.id,name:p.name,description:p.description,image_url:p.image_url,brand_id:p.brand_id,quantity:1};typeof addToCartFallback==='function'?addToCartFallback(pd):window.cartManager&&typeof window.cartManager.addToCart==='function'&&window.cartManager.addToCart(pd)})},100);return c}highlightCardText(c,p){const n=c.querySelector('.product-name'),d=c.querySelector('.product-description'),b=c.querySelector('.brand-badge');n&&(n.innerHTML=this.highlightText(p.name,this.currentQuery));if(d&&p.description){const s=p.description.length>100?p.description.substring(0,100)+'...':p.description;d.innerHTML=this.highlightText(s,this.currentQuery)}b&&p.brand_name&&(b.innerHTML=`ðŸ”– ${this.highlightText(p.brand_name,this.currentQuery)}`)}highlightText(t,q){if(!q||!t)return t;const r=new RegExp(`(${this.escapeRegExp(q)})`,'gi');return t.replace(r,'<mark>$1</mark>')}escapeRegExp(s){return s.replace(/[.*+?^${}()|[\]\\]/g,'\\$&')}updateResultsCount(){const c=document.getElementById('resultsCount');c&&(c.textContent=`trouvÃ© ${this.currentPage*this.limit}+ produits correspondants`)}showNoResults(){this.resultsGrid.innerHTML=`<div class="no-search-results" style="grid-column: 1 / -1;"><i class="fas fa-search"></i><h3>No results found for "${this.currentQuery}"</h3><p class="search-suggestions">Try different keywords or browse our brands</p><a href="index.html" class="btn" style="margin-top: 20px;"><i class="fas fa-home"></i> Back to Home</a></div>`}showError(){this.resultsGrid.innerHTML=`<div class="no-search-results" style="grid-column: 1 / -1;"><i class="fas fa-exclamation-triangle"></i><h3>Search temporarily unavailable</h3><p class="search-suggestions">Please try again in a few moments</p><button onclick="window.location.reload()" class="btn" style="margin-top: 20px;"><i class="fas fa-redo"></i> Retry</button></div>`}showLoading(s){this.loader&&(s?this.loader.classList.remove('hidden'):this.loader.classList.add('hidden'))}setupInfiniteScroll(){const o=new IntersectionObserver(e=>{e.forEach(e=>{e.isIntersecting&&this.hasMoreResults&&!this.isLoading&&this.loadResults()})},{rootMargin:'100px',threshold:.1});this.loader&&o.observe(this.loader);window.addEventListener('scroll',()=>{if(!this.hasMoreResults||this.isLoading)return;window.innerHeight+window.scrollY>=document.documentElement.scrollHeight-200&&this.loadResults()})}}window.initializeSearchSystem=function(){window.searchSystem=new SearchSystem;window.searchResultsPage=new SearchResultsPage};document.readyState==='loading'?document.addEventListener('DOMContentLoaded',window.initializeSearchSystem):window.initializeSearchSystem();window.SearchSystem=SearchSystem;window.SearchResultsPage=SearchResultsPage;